name: CI

on:
   push:
      branches: [main, dev]
   pull_request:
      branches: [main, dev]

jobs:
   backend:
      name: Backend - Laravel CI
      runs-on: ubuntu-latest

      services:
         postgres:
            image: postgres:17
            env:
               POSTGRES_USER: postgres
               POSTGRES_PASSWORD: postgres
               POSTGRES_DB: testing
            ports:
               - 5432:5432
            options: >-
               --health-cmd pg_isready
               --health-interval 10s
               --health-timeout 5s
               --health-retries 5

      env:
         DB_CONNECTION: pgsql
         DB_HOST: localhost
         DB_PORT: 5432
         DB_DATABASE: testing
         DB_USERNAME: postgres
         DB_PASSWORD: postgres

      defaults:
         run:
            working-directory: backend

      steps:
         - uses: actions/checkout@v4

         - name: Set up PHP
           uses: shivammathur/setup-php@v2
           with:
              php-version: 8.2
              extensions: pdo, pdo_pgsql, mbstring, xml, ctype, json, bcmath, gd
              coverage: none

         - name: Cache Composer dependencies
           uses: actions/cache@v4
           with:
              path: backend/vendor
              key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}
              restore-keys: |
                 ${{ runner.os }}-composer-

         - name: Install dependencies
           run: composer install --prefer-dist --no-progress --no-interaction

         - name: Copy environment file
           run: cp .env.example .env

         - name: Generate application key
           run: php artisan key:generate

         - name: Run migrations
           run: php artisan migrate --force

         - name: Run Laravel Pint
           run: ./vendor/bin/pint --test

         - name: Run tests
           run: php artisan test

   frontend:
      name: Frontend - React CI
      runs-on: ubuntu-latest

      defaults:
         run:
            working-directory: frontend

      steps:
         - uses: actions/checkout@v4

         - name: Set up Node.js
           uses: actions/setup-node@v4
           with:
              node-version: 22
              cache: npm
              cache-dependency-path: frontend/package-lock.json

         - name: Install dependencies
           run: npm ci

         - name: Run tests
           run: npm run test

         - name: Build
           run: npm run build
