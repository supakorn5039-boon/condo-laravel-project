networks:
  backend:
    name: ${DOCKER_NETWORK}
    driver: ${NETWORKS_DRIVER}

volumes:
  db_volumes:
    driver: ${VOLUMES_DRIVER}
  redis_volumes:
    driver: ${VOLUMES_DRIVER}

services:
  webserver:
    build:
      context: docker/nginx
      args:
        - CHANGE_SOURCE=false
        - PHP_UPSTREAM_CONTAINER=app
        - PHP_UPSTREAM_PORT=9000
        - http_proxy
        - https_proxy
        - no_proxy
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - .:/var/www:cached
      - ./storage/docker/logs/nginx:/var/log/nginx
      - ./docker/nginx/sites:/etc/nginx/sites-available
      - ./docker/nginx/ssl:/etc/nginx/ssl
    ports:
      - ${NGINX_PORT:-80}:80
      - ${NGINX_HTTPS_PORT:-443}:443
    depends_on:
      - app
    restart: always
    networks:
      - backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  ### PHP-FPM ##############################################
  app:
    build:
      context: docker/php-fpm
      args:
        - CHANGE_SOURCE=false
        - LARADOCK_PHP_VERSION=${PHP_VERSION}
        - BASE_IMAGE_TAG_PREFIX=master
        - PUID=${UID:-1000}
        - PGID=${GID:-1000}
        - INSTALL_OPCACHE=${INSTALL_OPCACHE:-false} #only enable on production
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    platform: linux/amd64
    volumes:
      - .:/var/www:cached
    restart: always
    networks:
      - backend
    depends_on:
      - redis
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  ### Supervisord ############################################
  supervisor:
    build:
      context: docker/php-worker
      args:
        - CHANGE_SOURCE=false
        - LARADOCK_PHP_VERSION=${PHP_VERSION}
        - INSTALL_PGSQL=true
        - INSTALL_REDIS=true
        - INSTALL_GD=true
        - PUID=${UID:-1000}
        - PGID=${GID:-1000}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - .:/var/www
      - ./docker/php-worker/supervisord.d:/etc/supervisord.d
    networks:
      - backend
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"
  ### PostgreSQL ############################################
  postgres:
    build:
      context: ./docker/postgres
    environment:
      - TZ=${TZ:-Asia/Bangkok}
      - POSTGRES_DB=${DB_DATABASE}
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --locale=C --lc-collate=th_TH.UTF-8
    volumes:
      - db_volumes:/var/lib/postgresql/data
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
    ports:
      - ${DB_PORT:-5432}:5432
    restart: unless-stopped
    networks:
      - backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      interval: 30s
      timeout: 10s
      retries: 3
  ### Redis ################################################
  redis:
    # don't forget to run on host machine
    # echo "vm.overcommit_memory = 1" >> /etc/sysctl.conf
    # sysctl -p
    build:
      context: docker/redis
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - redis_volumes:/data
    command: --requirepass ${REDIS_PASSWORD} --maxmemory 4056mb
    ports:
      - ${REDIS_PORT:-6379}:6379
    networks:
      - backend
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
  ### Mailhog ################################################
  mailhog:
    build:
      context: ./docker/mailhog
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_WEB_PORT:-8025}:8025"
    restart: unless-stopped
    platform: linux/amd64
    networks:
      - backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
